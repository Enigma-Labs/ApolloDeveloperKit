#!/bin/bash

usage() {
    echo 'usage: find-last-xcresult [--set-output]'
}

if [ $# -gt 1 ]; then
    echo "error: wrong number of arguments ($# for 0...1)" >&2
    usage >&2
    exit 1
fi

if [ "$1" = '-h' -o "$1" = '--help' ]; then
    usage
    exit
fi

set_output=
if [ "$1" = '--set-output' ]; then
    set_output=1
elif [ $# -eq 1 ]; then
    echo "error: unknown option '$1'" >&2
    usage >&2
    exit 1
fi

output=$(xcodebuild \
    -project ApolloDeveloperKit.xcodeproj \
    -scheme ApolloDeveloperKit \
    -configuration Debug \
    -showBuildSettings \
    2>/dev/null \
    | awk '/^ *BUILD_DIR =/{sub("Build/Products$", "Logs/Test/Test-*.xcresult", $3); print $3}' \
    | xargs -I{} bash -c 'ls -dt {} | head -n 1')
if [ -n "$set_output" ]; then
    output="::set-output name=path::$output"
fi
echo "$output"
