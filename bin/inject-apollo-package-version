#!/usr/bin/env ruby

require "json"
require "optparse"
require "shellwords"

inplace = false
version = nil
parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{opts.program_name} [-i] [-v VERSION] <PATH>"
  opts.on("-i", "--inplace", "Modify file in-place") do |i|
    inplace = true
  end
  opts.on("-vVERSION", "--version=VERSION", "Specify version") do |v|
    version = v
  end
end
args = parser.parse(ARGV)
raise "Wrong number of arguments (given #{args.size}, expected 1)" if args.size != 1
path = args.pop
json = JSON.parse(File.read(path))
apollo = json.dig("object", "pins").detect { |pin| pin["package"] == "Apollo" }
if version
  revision = `git ls-remote -t #{apollo["repositoryURL"].shellescape} #{version.shellescape}`.split[0]
  raise "No such version #{version}" unless revision
  apollo["state"]["version"] = version
  apollo["state"]["revision"] = revision
end
pretty_json = JSON.pretty_generate(json) + "\n"
if inplace
  File.write(path, pretty_json)
else
  $stdout.write(pretty_json)
end
