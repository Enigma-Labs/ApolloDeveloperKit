#!/bin/bash

# Do almost the same thing as Carthage but don't make a fat binary.

set -e

show_help() {
    cat <<-EOS
Usage: quick-install-dependencies [-h] [-f] <SDK>

Options:
    -h, --help   Show this help and exit
    -f, --force  Force build ignoring cache

Arguments:
    SDK          Specify SDK to build (macosx|iphoneos|iphonesimulator)
EOS
}

if [ $# -eq 0 -o $# -gt 2 ]; then
    echo "error: wrong number of arguments ($# for 1..2)." >&2
    show_help >&2
    exit 1
fi
force=0
sdk=
carthage_build_dir=
release_dir=
while [ $# -gt 0 ]
do
    case "$1" in
        -h|--help)
            show_help
            exit
            ;;
        -f|--force)
            force=1
            shift
            ;;
        macosx)
            sdk=macosx
            carthage_build_dir=Carthage/Build/Mac
            release_dir=Release
            shift
            ;;
        iphoneos)
            sdk=iphoneos
            carthage_build_dir=Carthage/Build/iOS
            release_dir=Release-iphoneos
            shift
            ;;
        iphonesimulator)
            sdk=iphonesimulator
            carthage_build_dir=Carthage/Build/iOS
            release_dir=Release-iphonesimulator
            shift
            ;;
        '')
            ;;
        *)
            echo "error: invalid argument '$1'." >&2
            show_help >&2
            exit 1
            ;;
    esac
done
if [ -z "$sdk" ]; then
    echo "error: wrong number of arguments ($# for 1..2)." >&2
    show_help >&2
    exit 1
fi

if [ $force -eq 0 -a -f "$carthage_build_dir/Apollo.framework/Apollo" -a -f "$carthage_build_dir/ApolloCore.framework/ApolloCore" ]; then
    echo 'Valid cache found.' >&2
    exit
fi

carthage checkout apollo-ios

derived_data_dir="$(mktemp -d -t DerivedData)"

mkdir -p "$derived_data_dir"
trap "rm -rf '$derived_data_dir'" EXIT
rm -rf "$carthage_build_dir"
mkdir -p "$carthage_build_dir"

for scheme in Apollo ApolloCore
do
    xcodebuild build \
        -project Carthage/Checkouts/apollo-ios/Apollo.xcodeproj \
        -scheme "$scheme" \
        -configuration Release \
        -derivedDataPath "$derived_data_dir" \
        -sdk "$sdk" \
        -quiet \
        ONLY_ACTIVE_ARCH=NO \
        CODE_SIGNING_REQUIRED=NO \
        CODE_SIGN_IDENTITY= \
        CARTHAGE=YES
    mv "$derived_data_dir/Build/Products/$release_dir/$scheme.framework" "$carthage_build_dir"
done
